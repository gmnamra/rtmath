C******************************************************************
C* COMPLEX REFRACTIVE INDEX OF WATER DROPS AND ICE-PARTICLES      * 
C* T  ---- TEMPERATURE IN  K                          ++ INPUT    *  
C* F  ---- FREQUENCY  IN  GHZ                         ++ INPUT    *
C* M  ---- REFRACTIVE INDEX                           ++ OUTPUT   *  
C******************************************************************
c complex index of ice
c based on Christian Matzler (2006)
	subroutine mice(f,t,m)
	complex m,e
c real part
	if(t>243) then
		er=3.1884+9.1e-4*(t-273)
	else 	
		er=3.1611+4.3e-4*(t-243)
	endif
c imaginary part
	theta=300/t-1
	alpha=(0.00504+0.0062*theta)*exp(-22.1*theta)
	dbeta=exp(-9.963+0.0372*(t-273.16))
	B1=0.0207
	B2=1.16E-11
	b=335
	betam=B1/t*exp(b/t)/(exp(b/t)-1)**2+B2*f**2
	beta=betam+dbeta
	ei=alpha/f+beta*f
	
	e=cmplx(er,-ei)
	m=csqrt(e)
	
	return
	end

c complex indice for ice
c BASED ON S. G. Warren (1984): Optical constant of ice from the
c ultraviolet to the microwave. Applied Optics, 23, 1206-1225.
	subroutine micew(f,t,m)
	complex m
	real t0(4),wl(62),p1(4,62),p2(4,62)      
	save t0,wl,p1,p2
	data t0/-1,-5,-20,-60/
	data (wl(i),(p1(j,i),p2(j,i),j=1,4),i=1,62)/
     +.1670,1.8296,8.30e-2,1.8296,8.30e-2,1.8296,8.30e-2,1.8296,8.30e-2,
     +.1778,1.8236,6.90e-2,1.8236,6.90e-2,1.8236,6.90e-2,1.8236,6.90e-2,
     +.1884,1.8315,5.70e-2,1.8315,5.70e-2,1.8315,5.70e-2,1.8315,5.70e-2,
     +.1995,1.8275,4.56e-2,1.8275,4.56e-2,1.8275,4.56e-2,1.8275,4.45e-2,
     +.2113,1.8222,3.79e-2,1.8222,3.79e-2,1.8222,3.79e-2,1.8222,3.55e-2,
     +.2239,1.8172,3.14e-2,1.8172,3.14e-2,1.8172,3.14e-2,1.8172,2.91e-2,
     +.2371,1.8120,2.62e-2,1.8120,2.62e-2,1.8120,2.62e-2,1.8120,2.44e-2,
     +.2512,1.8070,2.24e-2,1.8070,2.24e-2,1.8070,2.19e-2,1.8070,1.97e-2,
     +.2661,1.8025,1.96e-2,1.8025,1.96e-2,1.8025,1.88e-2,1.8025,1.67e-2,
     +.2818,1.7983,1.76e-2,1.7983,1.76e-2,1.7983,1.66e-2,1.7983,1.40e-2,
     +.2985,1.7948,1.67e-2,1.7948,1.67e-2,1.7948,1.54e-2,1.7948,1.26e-2,
     +.3162,1.7921,1.62e-2,1.7921,1.60e-2,1.7921,1.47e-2,1.7921,1.08e-2,
     +.3548,1.7884,1.55e-2,1.7884,1.50e-2,1.7884,1.35e-2,1.7884,8.90e-3,
     +.3981,1.7860,1.47e-2,1.7860,1.40e-2,1.7860,1.25e-2,1.7860,7.34e-3,
     +.4467,1.7843,1.39e-2,1.7843,1.31e-2,1.7843,1.15e-2,1.7843,6.40e-3,
     +.5012,1.7832,1.32e-2,1.7832,1.23e-2,1.7832,1.06e-2,1.7832,5.60e-3,
     +.5623,1.7825,1.25e-2,1.7825,1.15e-2,1.7825,9.77e-3,1.7825,5.00e-3,
     +.6310,1.7820,1.18e-2,1.7820,1.08e-2,1.7820,9.01e-3,1.7820,4.52e-3,
     +.7943,1.7817,1.06e-2,1.7817,9.46e-3,1.7816,7.66e-3,1.7815,3.68e-3,
     +1.000,1.7816,9.54e-3,1.7816,8.29e-3,1.7814,6.52e-3,1.7807,2.99e-3,
     +1.259,1.7819,8.56e-3,1.7819,7.27e-3,1.7816,5.54e-3,1.7801,2.49e-3,
     +2.500,1.7830,6.21e-3,1.7830,4.91e-3,1.7822,3.42e-3,1.7789,1.55e-3,
     +5.000,1.7843,4.49e-3,1.7843,3.30e-3,1.7831,2.10e-3,1.7779,9.61e-4,
     +10.00,1.7852,3.24e-3,1.7852,2.22e-3,1.7838,1.29e-3,1.7773,5.95e-4,
     +20.00,1.7862,2.34e-3,1.7861,1.49e-3,1.7839,7.93e-4,1.7772,3.69e-4,
     +32.00,1.7866,1.88e-3,1.7863,1.14e-3,1.7840,5.70e-4,1.7772,2.67e-4,
     +35.00,1.7868,1.74e-3,1.7864,1.06e-3,1.7840,5.35e-4,1.7772,2.51e-4,
     +40.00,1.7869,1.50e-3,1.7865,9.48e-4,1.7840,4.82e-4,1.7772,2.29e-4,
     +45.00,1.7870,1.32e-3,1.7865,8.50e-4,1.7840,4.38e-4,1.7772,2.11e-4,
     +50.00,1.7870,1.16e-3,1.7865,7.66e-4,1.7840,4.08e-4,1.7772,1.96e-4,
     +60.00,1.7871,8.80e-4,1.7865,6.30e-4,1.7839,3.50e-4,1.7772,1.73e-4,
     +70.00,1.7871,6.95e-4,1.7865,5.20e-4,1.7838,3.20e-4,1.7772,1.55e-4,
     +90.00,1.7872,4.64e-4,1.7865,3.84e-4,1.7837,2.55e-4,1.7772,1.31e-4,
     +111.0,1.7872,3.40e-4,1.7865,2.96e-4,1.7837,2.12e-4,1.7772,1.13e-4,
     +120.0,1.7872,3.11e-4,1.7865,2.70e-4,1.7837,2.00e-4,1.7772,1.06e-4,
     +130.0,1.7872,2.94e-4,1.7865,2.52e-4,1.7837,1.86e-4,1.7772,9.90e-5,
     +140.0,1.7872,2.79e-4,1.7865,2.44e-4,1.7837,1.75e-4,1.7772,9.30e-5,
     +150.0,1.7872,2.70e-4,1.7865,2.36e-4,1.7837,1.66e-4,1.7772,8.73e-5,
     +160.0,1.7872,2.64e-4,1.7865,2.30e-4,1.7837,1.56e-4,1.7772,8.30e-5,
     +170.0,1.7872,2.58e-4,1.7865,2.28e-4,1.7837,1.49e-4,1.7772,7.87e-5,
     +180.0,1.7872,2.52e-4,1.7865,2.25e-4,1.7837,1.44e-4,1.7772,7.50e-5,
     +200.0,1.7872,2.49e-4,1.7865,2.20e-4,1.7837,1.35e-4,1.7772,6.83e-5,
     +250.0,1.7872,2.54e-4,1.7865,2.16e-4,1.7837,1.21e-4,1.7772,5.60e-5,
     +290.0,1.7872,2.64e-4,1.7865,2.17e-4,1.7837,1.16e-4,1.7772,4.96e-5,
     +320.0,1.7872,2.74e-4,1.7865,2.20e-4,1.7837,1.16e-4,1.7772,4.55e-5,
     +350.0,1.7872,2.89e-4,1.7665,2.25e-4,1.7837,1.17e-4,1.7772,4.21e-5,
     +380.0,1.7872,3.05e-4,1.7865,2.32e-4,1.7837,1.20e-4,1.7772,3.91e-5,
     +400.0,1.7872,3.15e-4,1.7865,2.39e-4,1.7837,1.23e-4,1.7772,3.76e-5,
     +450.0,1.7872,3.46e-4,1.7865,2.60e-4,1.7837,1.32e-4,1.7772,3.40e-5,
     +500.0,1.7872,3.82e-4,1.7865,2.86e-4,1.7837,1.44e-4,1.7772,3.10e-5,
     +600.0,1.7872,4.62e-4,1.7865,3.56e-4,1.7837,1.68e-4,1.7772,2.64e-5,
     +640.0,1.7872,5.00e-4,1.7865,3.83e-4,1.7837,1.80e-4,1.7772,2.51e-5,
     +680.0,1.7872,5.50e-4,1.7865,4.15e-4,1.7837,1.90e-4,1.7772,2.43e-5,
     +720.0,1.7872,5.95e-4,1.7865,4.45e-4,1.7837,2.09e-4,1.7772,2.39e-5,
     +760.0,1.7872,6.47e-4,1.7865,4.76e-4,1.7837,2.16e-4,1.7772,2.37e-5,
     +800.0,1.7872,6.92e-4,1.7865,5.08e-4,1.7837,2.29e-4,1.7772,2.38e-5,
     +840.0,1.7872,7.42e-4,1.7865,5.40e-4,1.7837,2.40e-4,1.7772,2.40e-5,
     +900.0,1.7872,8.20e-4,1.7865,5.86e-4,1.7837,2.60e-4,1.7772,2.46e-5,
     +1000.,1.7872,9.70e-4,1.7865,6.78e-4,1.7837,2.92e-4,1.7772,2.66e-5,
     +2000.,1.7872,1.95e-3,1.7865,1.28e-3,1.7837,6.10e-4,1.7772,4.45e-5,
     +5000.,1.7872,5.78e-3,1.7865,3.55e-3,1.7840,1.02e-3,1.7772,8.70e-5,
     +8600.,1.7880,9.70e-3,1.7872,5.60e-3,1.7845,1.81e-3,1.7780,1.32e-4/

	f1=30/f*10.
	t1=t-273.15

	n1=0
	n2=0
	m1=0
	m2=0
        if(t1.ge.t0(1)) then
		n1=1
		n2=2
	else if(t1.le.t0(4)) then
		n1=3
		n2=4
	else
		do i=1,3
			if(t1.lt.t0(i) .and. t1.ge.t0(i+1)) then
				n1=i
				n2=i+1
			endif
		enddo
	endif
	if(n1.eq.0) then
		print*,"Out of Temperature Range."
		stop
	endif
	do i=1,61
		if(f1.gt.wl(i) .and. f1.le.wl(i+1)) then
			m1=i
			m2=i+1
		endif
	enddo
	if(m1.eq.0) then
		print*,"Out of Frequency Range."
		stop
	endif

	xe1=p1(n1,m1)+(p1(n1,m1)-p1(n2,m1))/(t0(n1)-t0(n2))*(t1-t0(n1))
	xe2=p2(n1,m1)+(p2(n1,m1)-p2(n2,m1))/(t0(n1)-t0(n2))*(t1-t0(n1))
	ye1=p1(n1,m2)+(p1(n1,m2)-p1(n2,m2))/(t0(n1)-t0(n2))*(t1-t0(n1))
	ye2=p2(n1,m2)+(p2(n1,m2)-p2(n2,m2))/(t0(n1)-t0(n2))*(t1-t0(n1))

	ze1=xe1+(xe1-ye1)/(wl(m1)-wl(m2))*(f1-wl(m1))
	ze2=xe2+(xe2-ye2)/(wl(m1)-wl(m2))*(f1-wl(m1))

	m=(1.0,0.0)*ze1+(0.0,-1.0)*ze2

	return
	end	

      SUBROUTINE mwater(FREQ,TEMP,m)
C     FREQ IN GHZ     (VALID FROM 0 TO 1000 GHZ)
C     TEMP IN KELVIN
C
C     REFERENCES:
C     LIEBE, HUFFORD AND MANABE, INT. J. IR & MM WAVES V.12, pp.659-675
C      (1991);  Liebe et al, AGARD Conf. Proc. 542, May 1993.
c
C     REVISION HISTORY:
C        PWR 8/3/92   original version
c        PWR 12/14/98 temp. dependence of EPS2 eliminated to agree 
c                     with MPM93 
C
      COMPLEX EPS,m
      THETA1 = 1.-300./TEMP
      EPS0 = 77.66 - 103.3*THETA1
      EPS1 = .0671*EPS0
      EPS2 = 3.52
      FP = (316.*THETA1 + 146.4)*THETA1 +20.20
      FS = 39.8*FP
      EPS = (EPS0-EPS1)/CMPLX(1.,FREQ/FP) +
     & (EPS1-EPS2)/CMPLX(1.,FREQ/FS) +EPS2
      m = csqrt(EPS)
      RETURN
      END

	subroutine msnow(f, t, m, rous)
C	f Frequency in GHz
C	t Temperature in K
C	m refrective index of snow
C	rous bulk density of snow

	complex m,e,beta,ei

C	Based on Bohren and Battan (1982) JAS, 39, 2623-2628.
C	Maxwell-Garnet formula for mixtures of air and ice
C       with randomly orientated ellipsoid.
C	matrix=ice, inclusion=air

	roui = 0.916		! density of pure ice
	vi = rous/roui		! fractional volume of ice (1-f)
	va = 1 - vi		! fractional volume of air (f)

	eair = 1.0		! dielectric constant of air (e)
	call mice(f,t,ei)
	ei = ei*ei		! dielectric constant of pur ice (em)

	beta = 2*ei/(eair-ei)*(eair/(eair-ei)*clog(eair/ei)-1)
	
	e=(vi*ei+beta*va*eair)/(vi+beta*va)

	m = csqrt(e)

	return
	end

